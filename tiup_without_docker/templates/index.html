<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title data-i18n="pageTitle">TiDB 版本测试平台 (TiUP)</title>
    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f7f6; color: #333; }
        h1 { color: #0b4f6c; }
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2em; flex-wrap: wrap; gap: 1em; }
        .top-nav .lang-switcher { position: static; top: auto; right: auto; margin-left: auto; }
        .auto-locate-link { display: inline-block; padding: 0.7em 1.2em; cursor: pointer; border: none; border-radius: 4px; background-color: #0b4f6c; color: white; font-size: 1em; text-decoration: none; text-align: center; line-height: 1; white-space: nowrap; }
        .auto-locate-link:hover { background-color: #012a36; }
        .container { display: flex; gap: 2em; }
        .form-section, .result-section { flex: 1; background-color: #fff; padding: 1.5em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        label { display: block; margin-top: 1em; font-weight: bold; }
        textarea, select, input { width: 100%; padding: 0.5em; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        select { min-height: 200px; }
        button { margin-top: 1em; padding: 0.7em 1.2em; cursor: pointer; border: none; border-radius: 4px; background-color: #0b4f6c; color: white; font-size: 1em; }
        button:hover { background-color: #012a36; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #results { background-color: #2d3748; color: #f7fafc; border: 1px solid #ccc; padding: 1em; min-height: 300px; white-space: pre-wrap; font-family: monospace; border-radius: 4px; overflow-x: auto; }
        .success { color: #48bb78; }
        .failure { color: #f56565; }
        .lang-switcher { position: absolute; top: 1em; right: 2em; }
        .component-counts { display: flex; gap: 1em; align-items: center; flex-wrap: wrap; }
        .component-counts label { margin-top: 0; white-space: nowrap; }
        .component-counts input { width: 60px; }
        .input-group { border: 1px solid #e2e8f0; border-radius: 6px; padding: 1em; margin-top: 1em; }
    </style>
</head>
<body>
    <div class="top-nav">
        <h1 data-i18n="mainHeader">TiDB 版本回归测试 (TiUP Playground)</h1>
        <a href="/locate" id="auto-locate-link" class="auto-locate-link" data-i18n="autoLocateBtn">Auto-Locate Bug</a>
        <div class="lang-switcher">
            <button id="lang-zh">中文</button>
            <button id="lang-en">English</button>
        </div>
    </div>

    <div class="container">
        <div class="form-section">
            <form id="test-form">
                <div class="input-group">
                    <label for="tidb-versions" data-i18n="selectVersion">Select the TiDB version (可多选):</label>
                    <select id="tidb-versions" multiple required>
                        {% for version in versions %}
                            <option value="{{ version }}">{{ version }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="input-group">
                    <label data-i18n="componentsLabel">Number of Components:</label>
                    <div class="component-counts">
                        <label for="tidb-count" data-i18n="tidbLabel">TiDB:</label>
                        <input type="number" id="tidb-count" value="1" min="0">
                        <label for="tikv-count" data-i18n="tikvLabel">TiKV:</label>
                        <input type="number" id="tikv-count" value="1" min="0">
                        <label for="pd-count" data-i18n="pdLabel">PD:</label>
                        <input type="number" id="pd-count" value="1" min="0">
                        <label for="tiflash-count" data-i18n="tiflashLabel">TiFlash:</label>
                        <input type="number" id="tiflash-count" value="0" min="0">
                    </div>
                </div>

                <div class="input-group">
                    <label for="sql-query" data-i18n="testCaseLabel">Test Case (SQL):</label>
                    <textarea id="sql-query" rows="5">SELECT 1;</textarea>

                    <label for="expected-sql-result" data-i18n="expectedSqlResultLabel">预期 SQL 结果检查:</label>
                    <textarea id="expected-sql-result" rows="3" data-i18n-placeholder="expectedSqlResultPlaceholder">[(1,)]</textarea>

                    <label for="other-check-script" data-i18n="otherCheckScriptLabel">其他检查 (Shell 脚本):</label>
                    <textarea id="other-check-script" rows="5" data-i18n-placeholder="otherCheckScriptPlaceholder"></textarea>
                </div>

                <button type="button" id="start-test-btn" data-i18n="startTestBtn">Start Test</button>
                <button type="button" id="clean-env-btn" data-i18n="cleanEnvBtn">Clean</button>
            </form>
        </div>
        <div class="result-section">
            <label data-i18n="executionResultsLabel">执行结果:</label>
            <div id="results" data-i18n-placeholder="waitingForTest">等待测试开始...</div>
        </div>
    </div>

<script>
const translations = {};
let currentLang = localStorage.getItem('lang') || (navigator.language.startsWith('en') ? 'en' : 'zh');

async function setLanguage(lang) {
    if (!translations[lang]) {
        try {
            const response = await fetch(`/locales/${lang}.json`);
            if (!response.ok) throw new Error(`Failed to load language file: ${response.statusText}`);
            translations[lang] = await response.json();
        } catch (error) {
            console.error(`Could not set language to ${lang}:`, error);
            return;
        }
    }
    localStorage.setItem('lang', lang);
    currentLang = lang;
    document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en-US';
    translatePage();
}

function translatePage() {
    const langPack = translations[currentLang];
    if (!langPack) return;
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (langPack[key]) element.textContent = langPack[key];
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        if (langPack[key]) element.placeholder = langPack[key];
    });
    const titleElement = document.querySelector('title[data-i18n]');
    if (titleElement) {
        const key = titleElement.getAttribute('data-i18n');
        if (langPack[key]) document.title = langPack[key];
    }
}

const resultBox = document.getElementById('results');
let pollInterval;

function disableButtons(state) {
    document.querySelectorAll('button').forEach(b => b.disabled = state);
}

function pollStatus(taskId) {
    if (pollInterval) clearInterval(pollInterval);
    localStorage.setItem('activeTestTaskId', taskId);

    pollInterval = setInterval(async () => {
        try {
            const response = await fetch(`/status/${taskId}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            updateResults(data);

            if (['complete', 'error', 'not_found'].includes(data.status)) {
                clearInterval(pollInterval);
                disableButtons(false);
                localStorage.removeItem('activeTestTaskId');
            }
        } catch (error) {
            resultBox.innerHTML += `\nPolling failed: ${error.message}`;
            clearInterval(pollInterval);
            disableButtons(false);
            localStorage.removeItem('activeTestTaskId');
        }
    }, 3000);
}

function updateResults(data) {
    let content = `<strong>Task Status: ${data.status}</strong>\n\n`;
    content += "<strong>Log:</strong>\n" + data.log.join('\n') + '\n\n';

    if (data.results && data.results.length > 0) {
         content += "<strong>Test Details:</strong>\n";
         data.results.forEach(res => {
             if (Object.keys(res).length === 0) return;
             content += `---------------------------------\n`;
             content += `Version: ${res.version}\n`;
             const statusClass = res.status === 'Success' ? 'success' : 'failure';
             content += `Status: <span class="${statusClass}">${res.status}</span>\n`;
             if (res.log_file) content += `Log File: ${res.log_file}\n`;
             if (res.error) {
                 content += `Error: ${res.error}\n`;
             } else {
                 content += `SQL Port: ${res.sql_port}, Dashboard Port: ${res.dashboard_port}\n`;
                 if (res.expected_sql !== undefined) content += `Expected SQL: ${res.expected_sql}\n`;
                 if (res.actual_sql !== undefined) content += `Actual SQL: ${res.actual_sql}\n`;
                 if (res.other_check_status) content += `Other Check Status: ${res.other_check_status}\n`;
                 if (res.other_check_output) content += `Other Check Output: ${res.other_check_output}\n`;
             }
         });
    }

    if (data.type === 'test' && data.status === 'complete') {
        const successVersions = data.results.filter(r => r.status === 'Success').map(r => r.version);
        const failedVersions = data.results.filter(r => r.status !== 'Success').map(r => r.version);
        content += "\n\n<strong>--- Summary ---</strong>\n";
        content += `Successful Versions: ${successVersions.join(', ') || 'None'}\n`;
        content += `Failed Versions: ${failedVersions.join(', ') || 'None'}\n`;
    }

    resultBox.innerHTML = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    resultBox.innerHTML = resultBox.innerHTML.replace(/&lt;span class="success"&gt;/g, '<span class="success">').replace(/&lt;span class="failure"&gt;/g, '<span class="failure">').replace(/&lt;\/span&gt;/g, '</span>').replace(/&lt;strong&gt;/g, '<strong>').replace(/&lt;\/strong&gt;/g, '</strong>');
}

async function cleanEnvironment(btn) {
    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = 'Cleaning...';
    resultBox.textContent += '\n\nStarting environment cleanup...';
    try {
        const response = await fetch('/clean', { method: 'POST' });
        const data = await response.json();
        let msg = `\nCleanup complete. Terminated ${data.cleaned_pids.length} processes.`;
        if (data.errors.length > 0) msg += `\nErrors: ${data.errors.join(', ')}`;
        resultBox.textContent += msg;
    } catch (error) {
        resultBox.textContent += `\nCleanup failed: ${error.message}`;
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    setLanguage(currentLang);
    document.getElementById('lang-zh').addEventListener('click', () => setLanguage('zh'));
    document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));

    const activeTaskId = localStorage.getItem('activeTestTaskId');
    if (activeTaskId) {
        resultBox.textContent = 'Resuming status check for a previous task...';
        disableButtons(true);
        pollStatus(activeTaskId);
    }

    document.getElementById('start-test-btn').addEventListener('click', async () => {
        const selectedOptions = document.getElementById('tidb-versions').selectedOptions;
        const versions = Array.from(selectedOptions).map(el => el.value);
        if (versions.length === 0) {
            alert(translations[currentLang]?.selectVersionAlert || 'Please select at least one TiDB version');
            return;
        }

        const expectedSqlResult = document.getElementById('expected-sql-result').value;
        const otherCheckScript = document.getElementById('other-check-script').value;

        disableButtons(true);
        resultBox.textContent = translations[currentLang]?.taskSubmitted || 'Task submitted, initializing...';

        const response = await fetch('/start_test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                versions,
                sql: document.getElementById('sql-query').value,
                expected_sql_result: expectedSqlResult,
                other_check_script: otherCheckScript,
                tidb: document.getElementById('tidb-count').value,
                tikv: document.getElementById('tikv-count').value,
                pd: document.getElementById('pd-count').value,
                tiflash: document.getElementById('tiflash-count').value
            })
        });

        const data = await response.json();
        if (data.task_id) {
            pollStatus(data.task_id);
        } else if (data.error) {
            resultBox.textContent = `Failed to start: ${data.error}`;
            disableButtons(false);
        }
    });

    document.getElementById('auto-locate-link').addEventListener('click', (event) => {
        event.preventDefault();
        localStorage.setItem('sqlQuery', document.getElementById('sql-query').value);
        localStorage.setItem('expectedSqlResult', document.getElementById('expected-sql-result').value);
        localStorage.setItem('otherCheckScript', document.getElementById('other-check-script').value);
        window.location.href = event.target.href;
    });

    document.getElementById('clean-env-btn').addEventListener('click', (e) => {
        cleanEnvironment(e.target);
    });
});
</script>
</body>
</html>
