<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>TiDB 版本测试平台 (TiUP)</title>
    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f7f6; color: #333; }
        h1 { color: #0b4f6c; }
        .container { display: flex; gap: 2em; }
        .form-section, .result-section { flex: 1; background-color: #fff; padding: 1.5em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        label { display: block; margin-top: 1em; font-weight: bold; }
        textarea, select, input { width: 100%; padding: 0.5em; border: 1px solid #ccc; border-radius: 4px; }
        select { min-height: 200px; }
        button { margin-top: 1em; padding: 0.7em 1.2em; cursor: pointer; border: none; border-radius: 4px; background-color: #0b4f6c; color: white; font-size: 1em; }
        button:hover { background-color: #012a36; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #results { background-color: #2d3748; color: #f7fafc; border: 1px solid #ccc; padding: 1em; min-height: 300px; white-space: pre-wrap; font-family: monospace; border-radius: 4px; overflow-x: auto; }
        .success { color: #48bb78; }
        .failure { color: #f56565; }
    </style>
</head>
<body>
    <h1>TiDB 版本回归测试 (TiUP Playground)</h1>
    <div class="container">
        <div class="form-section">
            <form id="test-form">
                <label for="tidb-versions">选择 TiDB 版本 (可多选):</label>
                <select id="tidb-versions" multiple required>
                    {% for version in versions %}
                        <option value="{{ version }}">{{ version }}</option>
                    {% endfor %}
                </select>

                <label for="sql-query">测试用例 (SQL 语句):</label>
                <textarea id="sql-query" rows="5">SELECT 1;</textarea>

                <label for="expected-result">预期结果:</label>
                <textarea id="expected-result" rows="3">[(1,)]</textarea>

                <button type="button" id="start-test-btn">开始测试</button>
                <button type="button" id="auto-locate-btn">自动定位 Bug</button>
                <button type="button" id="clean-env-btn">清理环境</button>
            </form>
        </div>
        <div class="result-section">
            <label>执行结果:</label>
            <div id="results">等待测试开始...</div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const resultBox = document.getElementById('results');
    let pollInterval;

    function disableButtons(state) {
        document.querySelectorAll('button').forEach(b => b.disabled = state);
    }

    function pollStatus(taskId) {
        if (pollInterval) clearInterval(pollInterval);

        pollInterval = setInterval(async () => {
            try {
                const response = await fetch(`/status/${taskId}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                updateResults(data);

                if (['complete', 'error', 'not_found'].includes(data.status)) {
                    clearInterval(pollInterval);
                    disableButtons(false);
                }
            } catch (error) {
                resultBox.innerHTML += `\nPolling failed: ${error.message}`;
                clearInterval(pollInterval);
                disableButtons(false);
            }
        }, 3000);
    }

    function updateResults(data) {
        let content = `<strong>任务状态: ${data.status}</strong>\n\n`;
        content += "<strong>日志:</strong>\n" + data.log.join('\n') + '\n\n';

        if (data.results && data.results.length > 0) {
             content += "<strong>测试详情:</strong>\n";
             data.results.forEach(res => {
                 if (Object.keys(res).length === 0) return;
                 content += `---------------------------------\n`;
                 content += `版本: ${res.version}\n`;
                 const statusClass = res.status === '成功' ? 'success' : 'failure';
                 content += `状态: <span class="${statusClass}">${res.status}</span>\n`;
                 if (res.log_file) {
                     content += `日志文件: ${res.log_file}\n`;
                 }
		 if (res.error) {
                     content += `错误: ${res.error}\n`;
                 } else {
                     content += `SQL Port: ${res.sql_port}, Dashboard Port: ${res.dashboard_port}\n`;
                     content += `预期: ${res.expected}\n`;
                     content += `实际: ${res.actual}\n`;
                 }
             });
        }

        if (data.type === 'test' && data.status === 'complete') {
            const successVersions = data.results.filter(r => r.status === '成功').map(r => r.version);
            const failedVersions = data.results.filter(r => r.status !== '成功').map(r => r.version);
            content += "\n\n<strong>--- 总结 ---</strong>\n";
            content += `成功版本: ${successVersions.join(', ') || '无'}\n`;
            content += `失败版本: ${failedVersions.join(', ') || '无'}\n`;
        }

        if (data.type === 'locate' && data.status === 'complete' && data.final_result) {
            content += `\n\n<strong>--- 最终定位结果 ---</strong>\n<strong class="failure">${data.final_result}</strong>\n`;
        }

        resultBox.innerHTML = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        resultBox.innerHTML = resultBox.innerHTML.replace(/&lt;span class="success"&gt;/g, '<span class="success">').replace(/&lt;span class="failure"&gt;/g, '<span class="failure">').replace(/&lt;\/span&gt;/g, '</span>').replace(/&lt;strong&gt;/g, '<strong>').replace(/&lt;\/strong&gt;/g, '</strong>');
    }

    async function cleanEnvironment(btn) {
        btn.disabled = true;
        btn.textContent = '清理中...';
        resultBox.textContent += '\n\n开始清理环境...';
        const response = await fetch('/clean', { method: 'POST' });
        const data = await response.json();
        let msg = `\n清理完成。 终止了 ${data.cleaned_pids.length} 个进程。`;
        if (data.errors.length > 0) msg += `\n错误: ${data.errors.join(', ')}`;
        resultBox.textContent += msg;
        btn.disabled = false;
        btn.textContent = '清理环境';
    }

    document.getElementById('start-test-btn').addEventListener('click', async () => {
        const selectedOptions = document.getElementById('tidb-versions').selectedOptions;
        const versions = Array.from(selectedOptions).map(el => el.value);
        if (versions.length === 0) {
            alert('请至少选择一个 TiDB 版本'); return;
        }

        disableButtons(true);
        resultBox.textContent = '任务已提交，正在初始化...';

        const response = await fetch('/start_test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                versions,
                sql: document.getElementById('sql-query').value,
                expected: document.getElementById('expected-result').value
            })
        });
        const data = await response.json();
        if (data.task_id) pollStatus(data.task_id);
    });

    document.getElementById('auto-locate-btn').addEventListener('click', () => {
        localStorage.setItem('sqlQuery', document.getElementById('sql-query').value);
        localStorage.setItem('expectedResult', document.getElementById('expected-result').value);
        window.location.href = '/locate';
    });

    document.getElementById('clean-env-btn').addEventListener('click', (e) => cleanEnvironment(e.target));
});
</script>
</body>
</html>
