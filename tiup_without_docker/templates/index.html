<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title data-i18n="pageTitle">TiDB 版本测试平台 (TiUP)</title>
    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f7f6; color: #333; }
        h1 { color: #0b4f6c; }
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2em;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 1em; /* Space between items */
        }
        .top-nav .lang-switcher { /* Adjust switcher position */
            position: static;
            top: auto;
            right: auto;
            margin-left: auto; /* Push switcher to the right */
        }
        .auto-locate-link {
            display: inline-block; /* Make it behave like a block for padding/margin */
            padding: 0.7em 1.2em;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background-color: #0b4f6c; /* Same as button color */
            color: white;
            font-size: 1em;
            text-decoration: none; /* Remove underline */
            text-align: center;
            line-height: 1; /* Adjust line height for vertical alignment */
            white-space: nowrap; /* Prevent text wrapping */
        }
        .auto-locate-link:hover {
            background-color: #012a36;
        }
        .container { display: flex; gap: 2em; }
        .form-section, .result-section { flex: 1; background-color: #fff; padding: 1.5em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        label { display: block; margin-top: 1em; font-weight: bold; }
        textarea, select, input { width: 100%; padding: 0.5em; border: 1px solid #ccc; border-radius: 4px; }
        select { min-height: 200px; }
        button { margin-top: 1em; padding: 0.7em 1.2em; cursor: pointer; border: none; border-radius: 4px; background-color: #0b4f6c; color: white; font-size: 1em; }
        button:hover { background-color: #012a36; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #results { background-color: #2d3748; color: #f7fafc; border: 1px solid #ccc; padding: 1em; min-height: 300px; white-space: pre-wrap; font-family: monospace; border-radius: 4px; overflow-x: auto; }
        .success { color: #48bb78; }
        .failure { color: #f56565; }
        .lang-switcher { position: absolute; top: 1em; right: 2em; }
        .component-counts {
            display: flex;         /* 1. 使用 Flexbox 布局 */
            gap: 1em;              /* 2. 在项目之间增加间距 */
            align-items: center;   /* 3. 垂直居中对齐项目 */
            flex-wrap: wrap;       /* 4. 在屏幕空间不足时允许换行 */
        }
        .component-counts label {
            margin-top: 0;         /* 5. 移除标签的顶部外边距 */
            white-space: nowrap;   /* 6. 防止标签文本换行 */
        }
        .component-counts input {
            width: 60px;           /* 7. 给输入框一个固定的宽度 */
        }
    </style>
</head>
<body>
    <div class="top-nav">
        <h1 data-i18n="mainHeader">TiDB 版本回归测试 (TiUP Playground)</h1>
        <a href="/locate" id="auto-locate-link" class="auto-locate-link" data-i18n="autoLocateBtn">Auto-Locate Bug</a>
        <div class="lang-switcher">
            <button id="lang-zh">中文</button>
            <button id="lang-en">English</button>
        </div>
    </div>

    <div class="container">
        <div class="form-section">
            <form id="test-form">
                <label for="tidb-versions" data-i18n="selectVersion">Select the TiDB version (可多选):</label>
                <select id="tidb-versions" multiple required>
                    {% for version in versions %}
                        <option value="{{ version }}">{{ version }}</option>
                    {% endfor %}
                </select>

                <label data-i18n="componentsLabel">Number of Components:</label>
                <div class="component-counts">
                    <label for="tidb-count" data-i18n="tidbLabel">TiDB:</label>
                    <input type="number" id="tidb-count" value="1" min="0">
                    <label for="tikv-count" data-i18n="tikvLabel">TiKV:</label>
                    <input type="number" id="tikv-count" value="1" min="0">
                    <label for="pd-count" data-i18n="pdLabel">PD:</label>
                    <input type="number" id="pd-count" value="1" min="0">
                    <label for="tiflash-count" data-i18n="tiflashLabel">TiFlash:</label>
                    <input type="number" id="tiflash-count" value="0" min="0">
                </div>

                <label for="sql-query" data-i18n="testCaseLabel">Test Case (SQL):</label>
                <textarea id="sql-query" rows="5">SELECT 1;</textarea>

                <label for="expected-result" data-i18n="expectedResultLabel">Expect result:</label>
                <textarea id="expected-result" rows="3">[(1,)]</textarea>

                <button type="button" id="start-test-btn" data-i18n="startTestBtn">Start Test</button>
                <button type="button" id="clean-env-btn" data-i18n="cleanEnvBtn">Clean</button>

            </form>
        </div>
        <div class="result-section">
            <label data-i18n="executionResultsLabel">执行结果:</label>
            <div id="results" data-i18n-placeholder="waitingForTest">等待测试开始...</div>
        </div>
    </div>

<script>
// --- 国际化脚本 ---
const translations = {};
let currentLang = localStorage.getItem('lang') || (navigator.language.startsWith('en') ? 'en' : 'zh');

async function setLanguage(lang) {
    if (!translations[lang]) {
        try {
            const response = await fetch(`/locales/${lang}.json`);
            if (!response.ok) throw new Error(`Failed to load language file: ${response.statusText}`);
            translations[lang] = await response.json();
        } catch (error) {
            console.error(`Could not set language to ${lang}:`, error);
            return;
        }
    }
    localStorage.setItem('lang', lang);
    currentLang = lang;
    document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en-US';
    translatePage();
}

function translatePage() {
    const langPack = translations[currentLang];
    if (!langPack) return;
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (langPack[key]) element.textContent = langPack[key];
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        if (langPack[key]) element.placeholder = langPack[key];
    });
    const titleElement = document.querySelector('title[data-i18n]');
    if (titleElement) {
        const key = titleElement.getAttribute('data-i18n');
        if (langPack[key]) document.title = langPack[key];
    }
}


// --- 应用程序核心逻辑函数 (修复关键) ---

const resultBox = document.getElementById('results');
let pollInterval;

function disableButtons(state) {
    document.querySelectorAll('button').forEach(b => b.disabled = state);
}

function pollStatus(taskId) {
    if (pollInterval) clearInterval(pollInterval);
    localStorage.setItem('activeTestTaskId', taskId); // 使用不同的 task_id key

    pollInterval = setInterval(async () => {
        try {
            const response = await fetch(`/status/${taskId}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            updateResults(data);

            if (['complete', 'error', 'not_found'].includes(data.status)) {
                clearInterval(pollInterval);
                disableButtons(false);
                localStorage.removeItem('activeTestTaskId');
            }
        } catch (error) {
            resultBox.innerHTML += `\nPolling failed: ${error.message}`;
            clearInterval(pollInterval);
            disableButtons(false);
            localStorage.removeItem('activeTestTaskId');
        }
    }, 3000);
}

function updateResults(data) {
    let content = `<strong>Task Status: ${data.status}</strong>\n\n`;
    content += "<strong>Log:</strong>\n" + data.log.join('\n') + '\n\n';

    if (data.results && data.results.length > 0) {
         content += "<strong>Test Details:</strong>\n";
         data.results.forEach(res => {
             if (Object.keys(res).length === 0) return;
             content += `---------------------------------\n`;
             content += `Version: ${res.version}\n`;
             const statusClass = res.status === 'Success' ? 'success' : 'failure';
             content += `Status: <span class="${statusClass}">${res.status}</span>\n`;
             if (res.log_file) {
                 content += `Log File: ${res.log_file}\n`;
             }
             if (res.error) {
                 content += `Error: ${res.error}\n`;
             } else {
                 content += `SQL Port: ${res.sql_port}, Dashboard Port: ${res.dashboard_port}\n`;
                 content += `Expected: ${res.expected}\n`;
                 content += `Actual: ${res.actual}\n`;
             }
         });
    }

    if (data.type === 'test' && data.status === 'complete') {
        const successVersions = data.results.filter(r => r.status === 'Success').map(r => r.version);
        const failedVersions = data.results.filter(r => r.status !== 'Success').map(r => r.version);
        content += "\n\n<strong>--- Summary ---</strong>\n";
        content += `Successful Versions: ${successVersions.join(', ') || 'None'}\n`;
        content += `Failed Versions: ${failedVersions.join(', ') || 'None'}\n`;
    }

    if (data.type === 'locate' && data.status === 'complete' && data.final_result) {
        content += `\n\n<strong>--- Final Result ---</strong>\n<strong class="failure">${data.final_result}</strong>\n`;
    }

    resultBox.innerHTML = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    resultBox.innerHTML = resultBox.innerHTML.replace(/&lt;span class="success"&gt;/g, '<span class="success">').replace(/&lt;span class="failure"&gt;/g, '<span class="failure">').replace(/&lt;\/span&gt;/g, '</span>').replace(/&lt;strong&gt;/g, '<strong>').replace(/&lt;\/strong&gt;/g, '</strong>');
}

async function cleanEnvironment(btn) {
    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = 'Cleaning...';
    resultBox.textContent += '\n\nStarting environment cleanup...';
    try {
        const response = await fetch('/clean', { method: 'POST' });
        const data = await response.json();
        let msg = `\nCleanup complete. Terminated ${data.cleaned_pids.length} processes.`;
        if (data.errors.length > 0) msg += `\nErrors: ${data.errors.join(', ')}`;
        resultBox.textContent += msg;
    } catch (error) {
        resultBox.textContent += `\nCleanup failed: ${error.message}`;
    } finally {
        btn.disabled = false;
        btn.textContent = originalText; // 恢复按钮原来的文本
    }
}


// --- 页面加载完成后的主逻辑 ---
document.addEventListener('DOMContentLoaded', function() {
    setLanguage(currentLang);
    document.getElementById('lang-zh').addEventListener('click', () => setLanguage('zh'));
    document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));

    const activeTaskId = localStorage.getItem('activeTestTaskId');
    if (activeTaskId) {
        resultBox.textContent = 'Resuming status check for a previous task...';
        disableButtons(true);
        pollStatus(activeTaskId);
    }

    // 【修复】为所有按钮绑定事件监听器
    document.getElementById('start-test-btn').addEventListener('click', async () => {
        const selectedOptions = document.getElementById('tidb-versions').selectedOptions;
        const versions = Array.from(selectedOptions).map(el => el.value);
        if (versions.length === 0) {
            alert(translations[currentLang]?.selectVersionAlert || 'Please select at least one TiDB version');
            return;
        }

        if (versions.length > 3) {
            alert(translations[currentLang]?.versionLimitAlert || 'You can select a maximum of 3 versions at a time.');
            return; // 阻止后续操作
        }

        // 【新增】检查选择的版本数量是否超过5个
        if (versions.length > 3) {
            // 从语言包获取提示信息
            alert(translations[currentLang]?.versionLimitAlert || 'You cannot select more than 3 versions at a time.');
            return; // 阻止后续操作
        }

        disableButtons(true);
        resultBox.textContent = translations[currentLang]?.taskSubmitted || 'Task submitted, initializing...';

        const tidb_count = document.getElementById('tidb-count').value;
        const tikv_count = document.getElementById('tikv-count').value;
        const pd_count = document.getElementById('pd-count').value;
        const tiflash_count = document.getElementById('tiflash-count').value;

        const response = await fetch('/start_test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                versions,
                sql: document.getElementById('sql-query').value,
                expected: document.getElementById('expected-result').value,
                tidb: tidb_count,
                tikv: tikv_count,
                pd: pd_count,
                tiflash: tiflash_count
            })
        });

        const data = await response.json();
        if (data.task_id) {
            pollStatus(data.task_id);
        } else if (data.error) {
            resultBox.textContent = `Failed to start: ${data.error}`;
            disableButtons(false);
        }
    });

    document.getElementById('auto-locate-link').addEventListener('click', () => {
        event.preventDefault();
        localStorage.setItem('sqlQuery', document.getElementById('sql-query').value);
        localStorage.setItem('expectedResult', document.getElementById('expected-result').value);

        // 只有在数据存储完毕后，才手动进行页面跳转
        window.location.href = event.target.href;
    });

    document.getElementById('clean-env-btn').addEventListener('click', (e) => {
        cleanEnvironment(e.target);
    });
});
</script>
</body>
</html>