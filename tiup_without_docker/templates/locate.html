<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>自动定位 Bug</title>
    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f7f6; color: #333; }
        h1 { color: #0b4f6c; }
        a { color: #0b4f6c; text-decoration: none; }
        .container { display: flex; gap: 2em; }
        .form-section, .result-section { flex: 1; background-color: #fff; padding: 1.5em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        label { display: block; margin-top: 1em; font-weight: bold; }
        textarea, input { width: 100%; padding: 0.5em; border: 1px solid #ccc; border-radius: 4px; }
        button { margin-top: 1em; padding: 0.7em 1.2em; cursor: pointer; border: none; border-radius: 4px; background-color: #0b4f6c; color: white; font-size: 1em; }
        button:hover { background-color: #012a36; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #results { background-color: #2d3748; color: #f7fafc; border: 1px solid #ccc; padding: 1em; min-height: 300px; white-space: pre-wrap; font-family: monospace; border-radius: 4px; overflow-x: auto; }
        .failure { color: #f56565; }
    </style>
</head>
<body>
    <h1>自动定位 Bug 版本</h1>
    <a href="/">&lt;&lt; 返回首页</a>
    <div class="container">
        <div class="form-section">
            <form id="locate-form">
                <label for="bug-version">Bug 上报版本:</label>
                <input type="text" id="bug-version" placeholder="输入一个已知的执行结果错误的版本" required>
                <label for="start-version">起始版本 (可选):</label>
                <input type="text" id="start-version" placeholder="输入二分查找的起始版本，默认 v5.4.0">
                <label for="sql-query">测试用例 (SQL):</label>
                <textarea id="sql-query" rows="5"></textarea>
                <label for="expected-result">预期结果:</label>
                <textarea id="expected-result" rows="3"></textarea>
                <button type="button" id="start-locate-btn">开始定位</button>
                <button type="button" id="clean-env-btn">清理环境</button>
            </form>
        </div>
        <div class="result-section">
            <label>执行结果:</label>
            <div id="results">等待定位开始...</div>
        </div>
    </div>
<script>
// The JS logic is identical to index.html, so it's duplicated for simplicity.
// In a real app, this would be a shared JS file.
document.addEventListener('DOMContentLoaded', function() {
    const resultBox = document.getElementById('results');
    let pollInterval;

    function disableButtons(state) {
        document.querySelectorAll('button').forEach(b => b.disabled = state);
    }

    // Copy-paste the pollStatus and updateResults functions from index.html here...
    function pollStatus(taskId) {
        if (pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(async () => {
            try {
                const response = await fetch(`/status/${taskId}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                updateResults(data);
                if (['complete', 'error', 'not_found'].includes(data.status)) {
                    clearInterval(pollInterval);
                    disableButtons(false);
                }
            } catch (error) {
                resultBox.innerHTML += `\nPolling failed: ${error.message}`;
                clearInterval(pollInterval);
                disableButtons(false);
            }
        }, 3000);
    }

    function updateResults(data) {
        let content = `<strong>任务状态: ${data.status}</strong>\n\n`;
        content += "<strong>日志:</strong>\n" + data.log.join('\n') + '\n\n';
        if (data.results && data.results.length > 0) {
             content += "<strong>测试详情:</strong>\n";
             data.results.forEach(res => {
                 if (Object.keys(res).length === 0) return;
                 content += `---------------------------------\n`;
                 content += `版本: ${res.version}\n`;
                 const statusClass = res.status === '成功' ? 'success' : 'failure';
                 content += `状态: <span class="${statusClass}">${res.status}</span>\n`;
                 if (res.log_file) {
                     content += `日志文件: ${res.log_file}\n`;
                 }
		 if (res.error) content += `错误: ${res.error}\n`;
                 else {
                     content += `SQL Port: ${res.sql_port}, Dashboard Port: ${res.dashboard_port}\n`;
                     content += `预期: ${res.expected}\n`;
                     content += `实际: ${res.actual}\n`;
                 }
             });
        }
        if (data.type === 'locate' && data.status === 'complete' && data.final_result) {
            content += `\n\n<strong>--- 最终定位结果 ---</strong>\n<strong class="failure">${data.final_result}</strong>\n`;
        }
        resultBox.innerHTML = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        resultBox.innerHTML = resultBox.innerHTML.replace(/&lt;span class="success"&gt;/g, '<span class="success">').replace(/&lt;span class="failure"&gt;/g, '<span class="failure">').replace(/&lt;\/span&gt;/g, '</span>').replace(/&lt;strong&gt;/g, '<strong>').replace(/&lt;\/strong&gt;/g, '</strong>');
    }
    // ... end of copy-paste

    if (localStorage.getItem('sqlQuery') && localStorage.getItem('sqlQuery') !== 'SELECT 1;') {
        document.getElementById('sql-query').value = localStorage.getItem('sqlQuery');
    }
    if (localStorage.getItem('expectedResult') && localStorage.getItem('expectedResult') !== '[(1,)]') {
        document.getElementById('expected-result').value = localStorage.getItem('expectedResult');
    }

    document.getElementById('start-locate-btn').addEventListener('click', async () => {
        const bug_version = document.getElementById('bug-version').value;
        if (!bug_version) {
            alert('请填写“Bug 上报版本”'); return;
        }
        disableButtons(true);
        resultBox.textContent = '定位任务已提交，正在初始化...';

        const response = await fetch('/start_locate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                bug_version,
                start_version: document.getElementById('start-version').value,
                sql: document.getElementById('sql-query').value,
                expected: document.getElementById('expected-result').value
            })
        });
        const data = await response.json();
        if (data.error) {
            resultBox.textContent = `启动失败: ${data.error}`;
            disableButtons(false);
        } else if (data.task_id) {
            pollStatus(data.task_id);
        }
    });

    document.getElementById('clean-env-btn').addEventListener('click', async (e) => {
        e.target.disabled = true;
        e.target.textContent = '清理中...';
        resultBox.textContent += '\n\n开始清理环境...';
        const response = await fetch('/clean', { method: 'POST' });
        const data = await response.json();
        let msg = `\n清理完成。 终止了 ${data.cleaned_pids.length} 个进程。`;
        if (data.errors.length > 0) msg += `\n错误: ${data.errors.join(', ')}`;
        resultBox.textContent += msg;
        e.target.disabled = false;
        e.target.textContent = '6. 清理环境';
    });
});
</script>
</body>
</html>
