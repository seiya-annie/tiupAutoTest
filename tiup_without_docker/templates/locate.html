<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title data-i18n="locateTitle">自动定位 Bug</title>
    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f7f6; color: #333; }
        h1 { color: #0b4f6c; }
        a { color: #0b4f6c; text-decoration: none; }
        .container { display: flex; gap: 2em; }
        .form-section, .result-section { flex: 1; background-color: #fff; padding: 1.5em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        label { display: block; margin-top: 1em; font-weight: bold; }
        textarea, input { width: 100%; padding: 0.5em; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { margin-top: 1.5em; padding: 0.7em 1.2em; cursor: pointer; border: none; border-radius: 4px; background-color: #0b4f6c; color: white; font-size: 1em; }
        button:hover { background-color: #012a36; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #results { background-color: #2d3748; color: #f7fafc; border: 1px solid #ccc; padding: 1em; min-height: 300px; white-space: pre-wrap; font-family: monospace; border-radius: 4px; overflow-x: auto; }
        .failure { color: #f56565; }
        .lang-switcher { position: absolute; top: 1em; right: 2em; }

        .mode-selector {
            display: flex;
            align-items: center;
            gap: 0.5em; /* 单选按钮和其标签之间的间距 */
            margin-top: 0.5em; /* 主标签下方的间距 */
        }
        .mode-selector label {
            margin-top: 0;
            font-weight: normal; /* 单选按钮的标签不加粗 */
        }
        /* 在第一个选项后增加一个较大的右边距，以分隔两个选项 */
        .mode-selector label[for="mode-version"] {
            margin-right: 1.5em;
        }
        /* 覆盖全局的 input 样式，使单选按钮宽度自适应 */
        .mode-selector input[type="radio"] {
            width: auto;
        }
        .component-counts { display: flex; gap: 1em; align-items: center; flex-wrap: wrap; }
        .component-counts label { margin-top: 0; white-space: nowrap; font-weight: normal; }
        .component-counts input { width: 60px; }
        .input-group { border: 1px solid #e2e8f0; border-radius: 6px; padding: 1em; margin-top: 1em; }
        .input-group label { margin-top: 0.5em; }
        .hidden { display: none; } /* 用于隐藏/显示输入框组 */
    </style>
</head>
<body>
    <div class="lang-switcher">
        <button id="lang-zh">中文</button>
        <button id="lang-en">English</button>
    </div>

    <h1 data-i18n="locateTitle">自动定位 Bug</h1>
    <a href="/" data-i18n="backToHome">&lt;&lt; 返回首页</a>
    <div class="container">
        <div class="form-section">
            <form id="locate-form">
                <!-- 定位模式选择 -->
                <label data-i18n="locateModeLabel">定位模式:</label>
                <div class="mode-selector">
                    <input type="radio" id="mode-version" name="locate-mode" value="version" checked>
                    <label for="mode-version" data-i18n="modeVersionLabel">按版本范围</label>
                    <input type="radio" id="mode-commit" name="locate-mode" value="commit">
                    <label for="mode-commit" data-i18n="modeCommitLabel">按 Commit 范围</label>
                </div>

                <!-- 按版本范围的输入框 -->
                <div id="version-inputs" class="input-group">
                    <label for="bug-version" data-i18n="bugVersionLabel">Bug 上报版本:</label>
                    <input type="text" id="bug-version" data-i18n-placeholder="bugVersionPlaceholder" required>
                    <label for="start-version" data-i18n="startVersionLabel">起始版本 (可选):</label>
                    <input type="text" id="start-version" data-i18n-placeholder="startVersionPlaceholder">
                </div>

                <!-- 按 Commit 范围的输入框 -->
                <div id="commit-inputs" class="input-group hidden">
                    <label for="tidb-branch" data-i18n="tidbBranchLabel">TiDB 分支:</label>
                    <input type="text" id="tidb-branch" data-i18n-placeholder="tidbBranchPlaceholder" required>
                    <label for="start-commit" data-i18n="startCommitLabel">起始 Commit:</label>
                    <input type="text" id="start-commit" data-i18n-placeholder="startCommitPlaceholder" required>
                    <label for="end-commit" data-i18n="endCommitLabel">结束 Commit:</label>
                    <input type="text" id="end-commit" data-i18n-placeholder="endCommitPlaceholder" required>
                </div>

                <!-- 公共参数 -->
                <div class="input-group">
                    <label data-i18n="componentsLabel">组件个数:</label>
                    <div class="component-counts">
                        <label for="tidb-count" data-i18n="tidbLabel">TiDB:</label>
                        <input type="number" id="tidb-count" value="1" min="0">
                        <label for="tikv-count" data-i18n="tikvLabel">TiKV:</label>
                        <input type="number" id="tikv-count" value="1" min="0">
                        <label for="pd-count" data-i18n="pdLabel">PD:</label>
                        <input type="number" id="pd-count" value="1" min="0">
                        <label for="tiflash-count" data-i18n="tiflashLabel">TiFlash:</label>
                        <input type="number" id="tiflash-count" value="0" min="0">
                    </div>
                </div>

                <div class="input-group">
                    <label for="sql-query" data-i18n="testCaseLabel">测试用例 (SQL):</label>
                    <textarea id="sql-query" rows="5"></textarea>
                    <!-- vvvvvvvvvvvv CHANGED vvvvvvvvvvvv -->
                    <label for="expected-sql-result" data-i18n="expectedSqlResultLabel">预期 SQL 结果检查:</label>
                    <textarea id="expected-sql-result" rows="3" data-i18n-placeholder="expectedSqlResultPlaceholder"></textarea>
                    <label for="other-check-script" data-i18n="otherCheckScriptLabel">其他检查 (Shell 脚本):</label>
                    <textarea id="other-check-script" rows="5" data-i18n-placeholder="otherCheckScriptPlaceholder"></textarea>
                    <!-- ^^^^^^^^^^^^ END CHANGED ^^^^^^^^^^^^ -->
                </div>

                <button type="button" id="start-locate-btn" data-i18n="startLocateBtn">开始定位</button>
                <button type="button" id="clean-env-btn" data-i18n="cleanEnvBtn">清理环境</button>
            </form>
        </div>
        <div class="result-section">
            <label data-i18n="executionResultsLabel">执行结果:</label>
            <div id="results" data-i18n-placeholder="waitingForLocate">等待定位开始...</div>
        </div>
    </div>
<script>
const translations = {};
let currentLang = localStorage.getItem('lang') || (navigator.language.startsWith('en') ? 'en' : 'zh');

async function setLanguage(lang) {
    if (!translations[lang]) {
        try {
            const response = await fetch(`/locales/${lang}.json`);
            if (!response.ok) throw new Error(`Failed to load language file: ${response.statusText}`);
            translations[lang] = await response.json();
        } catch (error) {
            console.error(`Could not set language to ${lang}:`, error);
            return;
        }
    }
    localStorage.setItem('lang', lang);
    currentLang = lang;
    document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en-US';
    translatePage();
}

function translatePage() {
    const langPack = translations[currentLang];
    if (!langPack) return;
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (langPack[key]) element.textContent = langPack[key];
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        if (langPack[key]) element.placeholder = langPack[key];
    });
    const titleElement = document.querySelector('title[data-i18n]');
    if (titleElement) {
        const key = titleElement.getAttribute('data-i18n');
        if (langPack[key]) document.title = langPack[key];
    }
}


// --- 应用程序核心逻辑 ---
const resultBox = document.getElementById('results');
let pollInterval;

function disableButtons(state) {
    document.querySelectorAll('button').forEach(b => b.disabled = state);
}
function pollStatus(taskId) {
    if (pollInterval) clearInterval(pollInterval);
    localStorage.setItem('activeLocateTaskId', taskId);
    pollInterval = setInterval(async () => {
        try {
            const response = await fetch(`/status/${taskId}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            updateResults(data);
            if (['complete', 'error', 'not_found'].includes(data.status)) {
                clearInterval(pollInterval);
                disableButtons(false);
                localStorage.removeItem('activeLocateTaskId');
            }
        } catch (error) {
            resultBox.innerHTML += `\nPolling failed: ${error.message}`;
            clearInterval(pollInterval);
            disableButtons(false);
            localStorage.removeItem('activeLocateTaskId');
        }
    }, 3000);
}

function updateResults(data) {
    let content = `<strong>Task Status: ${data.status}</strong>\n\n`;
    content += "<strong>Log:</strong>\n" + data.log.join('\n') + '\n\n';
    if (data.results && data.results.length > 0) {
         content += "<strong>Test Details:</strong>\n";
         data.results.forEach(res => {
             if (Object.keys(res).length === 0) return;
             content += `---------------------------------\n`;
             content += `Version: ${res.version}\n`;
             const statusClass = res.status === 'Success' ? 'success' : 'failure';
             content += `Status: <span class="${statusClass}">${res.status}</span>\n`;
             if (res.log_file) content += `Log File: ${res.log_file}\n`;
             if (res.error) content += `Error: ${res.error}\n`;
             else {
                 content += `SQL Port: ${res.sql_port}, Dashboard Port: ${res.dashboard_port}\n`;
                 if (res.expected_sql !== undefined) content += `Expected SQL: ${res.expected_sql}\n`;
                 if (res.actual_sql !== undefined) content += `Actual SQL: ${res.actual_sql}\n`;
                 if (res.other_check_status) content += `Other Check Status: ${res.other_check_status}\n`;
                 if (res.other_check_output) content += `Other Check Output: ${res.other_check_output}\n`;
             }
         });
    }
    if (data.type === 'locate' && data.status === 'complete' && data.final_result) {
        content += `\n\n<strong>--- Final Result ---</strong>\n<strong class="failure">${data.final_result}</strong>\n`;
    }
    resultBox.innerHTML = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    resultBox.innerHTML = resultBox.innerHTML.replace(/&lt;span class="success"&gt;/g, '<span class="success">').replace(/&lt;span class="failure"&gt;/g, '<span class="failure">').replace(/&lt;\/span&gt;/g, '</span>').replace(/&lt;strong&gt;/g, '<strong>').replace(/&lt;\/strong&gt;/g, '</strong>');
}

async function cleanEnvironment(btn) {
    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = 'Cleaning...';
    resultBox.textContent += '\n\nStarting environment cleanup...';
    try {
        const response = await fetch('/clean', { method: 'POST' });
        const data = await response.json();
        let msg = `\nCleanup complete. Terminated ${data.cleaned_pids.length} processes.`;
        if (data.errors.length > 0) msg += `\nErrors: ${data.errors.join(', ')}`;
        resultBox.textContent += msg;
    } catch (error) {
        resultBox.textContent += `\nCleanup failed: ${error.message}`;
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}
// --- 页面加载完成后的主逻辑 ---
document.addEventListener('DOMContentLoaded', function() {
    setLanguage(currentLang);
    document.getElementById('lang-zh').addEventListener('click', () => setLanguage('zh'));
    document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));

    const activeTaskId = localStorage.getItem('activeLocateTaskId');
    if (activeTaskId) {
        resultBox.textContent = 'Resuming status check for a previous task...';
        disableButtons(true);
        pollStatus(activeTaskId);
    }
    // Restore saved inputs from localStorage
    if (localStorage.getItem('sqlQuery')) {
        document.getElementById('sql-query').value = localStorage.getItem('sqlQuery');
    }
    if (localStorage.getItem('expectedSqlResult')) {
        document.getElementById('expected-sql-result').value = localStorage.getItem('expectedSqlResult');
    }
    if (localStorage.getItem('otherCheckScript')) {
        document.getElementById('other-check-script').value = localStorage.getItem('otherCheckScript');
    }


    const modeVersionRadio = document.getElementById('mode-version');
    const modeCommitRadio = document.getElementById('mode-commit');
    const versionInputs = document.getElementById('version-inputs');
    const commitInputs = document.getElementById('commit-inputs');

    function toggleInputs() {
        if (modeVersionRadio.checked) {
            versionInputs.classList.remove('hidden');
            commitInputs.classList.add('hidden');
        } else {
            versionInputs.classList.add('hidden');
            commitInputs.classList.remove('hidden');
        }
    }
    modeVersionRadio.addEventListener('change', toggleInputs);
    modeCommitRadio.addEventListener('change', toggleInputs);
    toggleInputs();

    document.getElementById('start-locate-btn').addEventListener('click', async () => {
        const locateMode = document.querySelector('input[name="locate-mode"]:checked').value;
        const expectedSqlResult = document.getElementById('expected-sql-result').value;
        const otherCheckScript = document.getElementById('other-check-script').value;

        const payload = {
            locate_mode: locateMode,
            sql: document.getElementById('sql-query').value,
            expected_sql_result: expectedSqlResult,
            other_check_script: otherCheckScript,
            tidb: document.getElementById('tidb-count').value,
            tikv: document.getElementById('tikv-count').value,
            pd: document.getElementById('pd-count').value,
            tiflash: document.getElementById('tiflash-count').value,
        };

        if (locateMode === 'version') {
            payload.bug_version = document.getElementById('bug-version').value;
            payload.start_version = document.getElementById('start-version').value;
            if (!payload.bug_version) {
                alert(translations[currentLang]?.bugVersionAlert || 'Please fill in the "Bug Reported Version".');
                return;
            }
        } else {
            payload.branch = document.getElementById('tidb-branch').value;
            payload.start_commit = document.getElementById('start-commit').value;
            payload.end_commit = document.getElementById('end-commit').value;
            if (!payload.branch || !payload.start_commit || !payload.end_commit) {
                alert(translations[currentLang]?.commitFieldsAlert || 'Please fill in all commit-related fields.');
                return;
            }
        }

        // Save inputs to localStorage
        localStorage.setItem('sqlQuery', payload.sql);
        localStorage.setItem('expectedSqlResult', payload.expected_sql_result);
        localStorage.setItem('otherCheckScript', payload.other_check_script);


        disableButtons(true);
        resultBox.textContent = translations[currentLang]?.waitingForLocate || 'Location task submitted, initializing...';

        const response = await fetch('/start_locate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await response.json();
        if (data.error) {
            resultBox.textContent = `Failed to start: ${data.error}`;
            disableButtons(false);
        } else if (data.task_id) {
            pollStatus(data.task_id);
        }
    });

    // 为“清理环境”按钮绑定事件
    document.getElementById('clean-env-btn').addEventListener('click', (e) => {
        cleanEnvironment(e.target);
    });
});
</script>
</body>
</html>
